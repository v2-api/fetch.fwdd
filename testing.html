<!DOCTYPE html>
<html>
<head>
  <title>P2P Chat with PeerJS (Free Server)</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; }
    #peer-id { font-weight: bold; }
  </style>
</head>
<body>

<h1>P2P Chat</h1>

<div>Your Peer ID: <span id="peer-id">...</span></div>

<label for="connect-id">Connect to Peer ID:</label>
<input id="connect-id" type="text" placeholder="Enter peer ID"/>
<button id="connect-btn">Connect</button>

<div id="messages"></div>

<input id="message-input" type="text" placeholder="Type a message..." disabled/>
<button id="send-btn" disabled>Send</button>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
  // Use default free public PeerJS server
  const peer = new Peer();

  const peerIdSpan = document.getElementById('peer-id');
  const connectBtn = document.getElementById('connect-btn');
  const connectIdInput = document.getElementById('connect-id');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');

  let conn;

  function logMessage(msg, fromSelf = false) {
    const p = document.createElement('p');
    p.textContent = (fromSelf ? "You: " : "Peer: ") + msg;
    p.style.textAlign = fromSelf ? 'right' : 'left';
    messagesDiv.appendChild(p);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  peer.on('open', id => {
    peerIdSpan.textContent = id;
  });

  connectBtn.onclick = () => {
    if (conn) {
      conn.close();
    }
    const peerIdToConnect = connectIdInput.value.trim();
    if (!peerIdToConnect) return alert("Enter a peer ID");
    conn = peer.connect(peerIdToConnect);

    conn.on('open', () => {
      logMessage('Connected!', true);
      messageInput.disabled = false;
      sendBtn.disabled = false;
    });

    conn.on('data', data => {
      logMessage(data);
    });

    conn.on('close', () => {
      logMessage('Connection closed');
      messageInput.disabled = true;
      sendBtn.disabled = true;
    });
  };

  peer.on('connection', connection => {
    if (conn) {
      conn.close();
    }
    conn = connection;

    conn.on('data', data => {
      logMessage(data);
    });

    conn.on('open', () => {
      logMessage('Peer connected');
      messageInput.disabled = false;
      sendBtn.disabled = false;
    });

    conn.on('close', () => {
      logMessage('Connection closed');
      messageInput.disabled = true;
      sendBtn.disabled = true;
    });
  });

  sendBtn.onclick = () => {
    const message = messageInput.value.trim();
    if (!message || !conn || !conn.open) return;
    conn.send(message);
    logMessage(message, true);
    messageInput.value = '';
  };

  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') sendBtn.click();
  });
</script>

</body>
</html>
