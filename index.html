<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GitHub Pages Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { width: 400px; padding: 10px; }
    button { padding: 10px 15px; }
  </style>
</head>
<body>
  <div id="hidden">
    <h2>GitHub Pages Viewer</h2>
    <p>Enter a GitHub Pages site (e.g. <code>https://username.github.io/project</code>):</p>
    <input type="text" id="siteInput" placeholder="https://username.github.io/project">
    <button onclick="start()">Load Site</button>
  </div>

  <script>
    async function fetchAndReplace(targetUrl) {
      try {
        const response = await fetch(targetUrl);
        if (!response.ok) throw new Error('Failed to fetch: ' + targetUrl);

        let html = await response.text();

        // Parse HTML into DOM
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        // Helper: rewrite any attribute that is a URL
        function rewriteUrl(el, attr) {
          let val = el.getAttribute(attr);
          if (!val) return;
          // Relative or github.io links get rewritten
          if (/^https?:\/\/.*github\.io/.test(val) || !/^https?:|^\/\//.test(val)) {
            const absolute = new URL(val, targetUrl).href;
            if (attr === "href" && el.tagName.toLowerCase() === "a") {
              el.setAttribute(attr, "/?l=" + absolute);
            } else if (el.tagName.toLowerCase() === "iframe") {
              el.setAttribute(attr, "/?l=" + absolute);
            } else {
              el.setAttribute(attr, absolute);
            }
          }
        }

        // Rewrite href/src/srcset everywhere
        doc.querySelectorAll("[href],[src],[srcset]").forEach(el => {
          if (el.hasAttribute("href")) rewriteUrl(el, "href");
          if (el.hasAttribute("src")) rewriteUrl(el, "src");
          if (el.hasAttribute("srcset")) {
            let srcset = el.getAttribute("srcset");
            if (srcset) {
              let newSet = srcset.split(",").map(s => {
                let [url, size] = s.trim().split(/\s+/);
                if (/^https?:\/\/.*github\.io/.test(url) || !/^https?:|^\/\//.test(url)) {
                  url = new URL(url, targetUrl).href;
                }
                return size ? url + " " + size : url;
              }).join(", ");
              el.setAttribute("srcset", newSet);
            }
          }
        });

        // Try to also rewrite inline iframe documents (same-origin only)
        doc.querySelectorAll("iframe").forEach(iframe => {
          try {
            const innerDoc = iframe.contentDocument || iframe.contentWindow?.document;
            if (innerDoc) {
              innerDoc.querySelectorAll("[href],[src],[srcset]").forEach(el => {
                if (el.hasAttribute("href")) rewriteUrl(el, "href");
                if (el.hasAttribute("src")) rewriteUrl(el, "src");
                if (el.hasAttribute("srcset")) {
                  let srcset = el.getAttribute("srcset");
                  if (srcset) {
                    let newSet = srcset.split(",").map(s => {
                      let [url, size] = s.trim().split(/\s+/);
                      if (/^https?:\/\/.*github\.io/.test(url) || !/^https?:|^\/\//.test(url)) {
                        url = new URL(url, targetUrl).href;
                      }
                      return size ? url + " " + size : url;
                    }).join(", ");
                    el.setAttribute("srcset", newSet);
                  }
                }
              });
            }
          } catch (e) {
            // Cross-origin iframes can't be accessed, ignore
          }
        });

        // Replace current page content
        document.open();
        document.write("<!DOCTYPE html>" + doc.documentElement.outerHTML);
        document.close();

      } catch (err) {
        console.error(err);
        alert("Error loading: " + targetUrl);
      }
    }

    function start() {
      const siteUrl = document.getElementById("siteInput").value.trim().replace(/\/$/, "");
      if (!siteUrl.startsWith("http")) {
        alert("Please enter a valid site URL (must start with http)");
        return;
      }
      const indexUrl = siteUrl + "/index.html";
      history.replaceState(null, "", "/?l=" + indexUrl);
      fetchAndReplace(indexUrl);
    }

    // On load: check for ?l= param
    (function() {
      const params = new URLSearchParams(window.location.search);
      const l = params.get("l");
      if (l) {
        document.getElementById("hidden").style.visibility = "hidden";
        fetchAndReplace(l);
      }
    })();
  </script>
</body>
</html>
