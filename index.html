<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GitHub Pages Loader</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { width: 400px; padding: 10px; }
    button { padding: 10px 15px; }
  </style>
</head>
<body>
  <h2>GitHub Pages Viewer</h2>
  <p>Enter a GitHub Pages site URL:</p>
  <input type="text" id="siteInput" placeholder="https://username.github.io/project">
  <button onclick="loadFromInput()">Load Site</button>

  <script>
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function isRelative(url) {
      return !/^(https?:|\/\/|#|mailto:|javascript:)/.test(url);
    }

    async function loadAndReplace(siteUrl) {
      if (!siteUrl.startsWith('http')) {
        alert('Invalid URL: ' + siteUrl);
        return;
      }

      try {
        const response = await fetch(siteUrl);
        if (!response.ok) throw new Error('Failed to fetch: ' + siteUrl);

        let html = await response.text();

        const baseUrl = siteUrl.replace(/\/[^\/]*$/, '/'); // Remove filename

        // Rewriting relative href/src attributes
        html = html.replace(/(href|src)=["']([^"']+)["']/g, (match, attr, link) => {
          if (isRelative(link)) {
            const absolute = baseUrl + link.replace(/^\//, '');
            return `${attr}="${absolute}"`;
          }
          return match;
        });

        // Rewrite <a> links to redirect through this tool using ?l=
        html = html.replace(/<a\s+([^>]*?)href=["']([^"']+)["']/gi, (match, preAttrs, link) => {
          let newHref = link;

          if (isRelative(link)) {
            newHref = baseUrl + link.replace(/^\//, '');
          }

          const redirected = `${window.location.origin + window.location.pathname}?l=${encodeURIComponent(newHref)}`;
          return `<a ${preAttrs}href="${redirected}"`;
        });

        document.open();
        document.write(html);
        document.close();
      } catch (err) {
        console.error(err);
        alert('Error loading site: ' + err.message);
      }
    }

    function loadFromInput() {
      const inputUrl = document.getElementById('siteInput').value.trim().replace(/\/$/, '');
      if (inputUrl) {
        const newUrl = `${window.location.origin + window.location.pathname}?l=${encodeURIComponent(inputUrl)}`;
        window.location.href = newUrl;
      }
    }

    // On page load: if ?l= is present, fetch and display that site
    const linkParam = getParam('l');
    if (linkParam) {
      loadAndReplace(linkParam);
    }
  </script>
</body>
</html>
