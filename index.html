<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GitHub Pages Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input { width: 400px; padding: 10px; }
    button { padding: 10px 15px; }
  </style>
</head>
<body>
  <div id="hidden">
    <h2>GitHub Pages Viewer</h2>
    <p>Enter a GitHub Pages site (e.g. <code>https://username.github.io/project</code>):</p>
    <input type="text" id="siteInput" placeholder="https://username.github.io/project">
    <button onclick="start()">Load Site</button>
  </div>
  <script>
    async function fetchAndReplace(targetUrl) {
      try {
        const response = await fetch(targetUrl);
        if (!response.ok) throw new Error('Failed to fetch: ' + targetUrl);

        let html = await response.text();

        // Create a DOM to safely manipulate links
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        // Fix all <a> hrefs and <img/script/link> src/href
        doc.querySelectorAll("a[href]").forEach(a => {
          let href = a.getAttribute("href");
          if (!href) return;
          // relative or github.io link
          if (/^https?:\/\/.*github\.io/.test(href) || !/^https?:|^\/\//.test(href)) {
            const absolute = new URL(href, targetUrl).href;
            a.setAttribute("href", "/?l=" + absolute);
          }
        });

        doc.querySelectorAll("[src],link[href]").forEach(el => {
          const attr = el.hasAttribute("src") ? "src" : "href";
          let path = el.getAttribute(attr);
          if (!path) return;
          if (!/^https?:|^\/\//.test(path)) {
            el.setAttribute(attr, new URL(path, targetUrl).href);
          }
        });

        // Replace current page content
        document.open();
        document.write("<!DOCTYPE html>" + doc.documentElement.outerHTML);
        document.close();
      } catch (err) {
        console.error(err);
        alert("Error loading: " + targetUrl);
      }
    }

    function start() {
      const siteUrl = document.getElementById("siteInput").value.trim().replace(/\/$/, "");
      if (!siteUrl.startsWith("http")) {
        alert("Please enter a valid site URL (must start with http)");
        return;
      }
      const indexUrl = siteUrl + "/index.html";
      history.replaceState(null, "", "/?l=" + indexUrl);
      fetchAndReplace(indexUrl);
    }

    // On load: check for ?l= param
    (function() {
      const params = new URLSearchParams(window.location.search);
      const l = params.get("l");
      if (l) {
        document.getElementById("hidden").style.visibility = "hidden";
        fetchAndReplace(l);
      }
    })();
  </script>
</body>
</html>
