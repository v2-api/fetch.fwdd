<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GitHub Pages Viewer</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      padding: 1em;
    }
    iframe {
      width: 100%;
      height: 90vh;
      border: 1px solid #ccc;
    }
    input[type="text"] {
      width: 80%;
      padding: 0.5em;
      font-size: 1em;
    }
    button {
      padding: 0.5em 1em;
      font-size: 1em;
      margin-left: 0.5em;
    }
  </style>
</head>
<body>
  <div id="app">Loading...</div>

  <script>
    const params = new URLSearchParams(location.search);
    const targetURL = params.get("l");

    const container = document.getElementById("app");

    if (!targetURL) {
      // ---------- NO PARAM: SHOW INPUT FORM ----------
      container.innerHTML = `
        <h2>GitHub Pages Viewer</h2>
        <input type="text" id="ghurl" placeholder="Enter .github.io URL" />
        <button onclick="loadSite()">View</button>
      `;

      window.loadSite = function () {
        const input = document.getElementById("ghurl").value.trim();
        if (!input.includes(".github.io")) {
          alert("Please enter a valid .github.io URL.");
          return;
        }

        const url = new URL(input.startsWith("http") ? input : "https://" + input);
        location.href = location.pathname + "?l=" + encodeURIComponent(url.href);
      };

    } else {
      // ---------- WITH PARAM: FETCH AND RENDER ----------
      fetchAndRender(targetURL);
    }

    async function fetchAndRender(url) {
      if (!url.includes(".github.io")) {
        container.innerHTML = "Invalid or missing URL.";
        return;
      }

      try {
        const response = await fetch(url);
        const html = await response.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");

        const baseURL = new URL(url);
        const githubDomain = baseURL.hostname;

        function rewrite(href) {
          if (!href) return href;
          try {
            const absolute = new URL(href, baseURL);
            if (
              absolute.hostname.endsWith(".github.io") ||
              absolute.hostname === githubDomain
            ) {
              return location.pathname + "?l=" + encodeURIComponent(absolute.href);
            }
            return absolute.href;
          } catch {
            return href;
          }
        }

        doc.querySelectorAll("[href], [src]").forEach(el => {
          if (el.hasAttribute("href")) {
            el.setAttribute("href", rewrite(el.getAttribute("href")));
          }
          if (el.hasAttribute("src")) {
            el.setAttribute("src", rewrite(el.getAttribute("src")));
          }
        });

        const blob = new Blob([doc.documentElement.outerHTML], { type: "text/html" });
        const blobURL = URL.createObjectURL(blob);

        const iframe = document.createElement("iframe");
        iframe.src = blobURL;

        container.innerHTML = "";
        container.appendChild(iframe);

      } catch (err) {
        container.innerText = "Error fetching page: " + err.message;
      }
    }
  </script>
</body>
</html>
