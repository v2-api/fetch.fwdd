<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Phone Proxy</title>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    html, body {
      margin:0; padding:0;
      height:100%; width:100%;
      overflow:hidden;
      font-family: system-ui, sans-serif;
      background:#fafafa;
      display:flex; justify-content:center; align-items:center;
      padding:1rem;
    }
    .card {
      background:#fff; border:1px solid #ddd;
      border-radius:12px; padding:2rem;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      width:100%; max-width:400px;
      text-align:center;
    }
    h1 { font-size:1.3rem; margin:0 0 1rem; }
    input, button {
      font-size:1rem; padding:0.6rem 0.8rem;
      border-radius:8px; border:1px solid #ccc;
      margin:0.4rem 0; box-sizing:border-box;
      width:100%;
    }
    button {
      background:#0b74de; color:white; border:none; cursor:pointer;
    }
    button:hover { background:#095ab0; }
    .link { color:#0b74de; font-size:0.9rem; cursor:pointer; margin-top:0.6rem; display:inline-block; }
    .status { margin-bottom:1rem; font-size:0.95rem; color:#333; }
    #result {
      text-align:left; white-space:pre-wrap; font-family:monospace;
      font-size:0.85rem; margin-top:1rem;
      background:#f6f6f6; padding:0.8rem; border-radius:8px;
      max-height:250px; overflow:auto;
    }
  </style>
</head>
<body>
  <!-- Phone UI -->
  <div class="card" id="phoneUI" hidden>
    <h1>Your Code</h1>
    <div style="font-size:2rem; font-weight:bold; margin:1rem 0;" id="phoneCode">------</div>
    <div class="link" id="switchToComputer">I'm not on mobile</div>
  </div>

  <!-- Computer UI -->
  <div class="card" id="computerUI" hidden>
    <h1>Enter Phone Code</h1>
    <input id="codeInput" placeholder="6-digit code"/>
    <button id="connectBtn">Connect</button>
    <div class="link" id="switchToPhone">I'm not on computer</div>
  </div>

  <!-- Connected UI -->
  <div class="card" id="connectedUI" hidden>
    <div class="status" id="statusLine">✅ Connected • Uptime <span id="uptime">0s</span></div>
    <div id="searchSection" hidden>
      <input id="urlInput" placeholder="Enter URL to fetch"/>
      <button id="sendBtn">Search</button>
      <div id="result"></div>
    </div>
  </div>

  <!-- Disconnected UI -->
  <div class="card" id="disconnectedUI" hidden>
    <h1>Disconnected</h1>
    <p style="margin:1rem 0;">⚠️ Connection lost</p>
    <button id="reconnectBtn">Reconnect</button>
  </div>

<script>
(() => {
  const phoneUI = document.getElementById('phoneUI');
  const computerUI = document.getElementById('computerUI');
  const connectedUI = document.getElementById('connectedUI');
  const disconnectedUI = document.getElementById('disconnectedUI');

  const phoneCodeEl = document.getElementById('phoneCode');
  const switchToComputer = document.getElementById('switchToComputer');
  const switchToPhone = document.getElementById('switchToPhone');
  const codeInput = document.getElementById('codeInput');
  const connectBtn = document.getElementById('connectBtn');
  const reconnectBtn = document.getElementById('reconnectBtn');

  const uptimeEl = document.getElementById('uptime');
  const statusLine = document.getElementById('statusLine');
  const urlInput = document.getElementById('urlInput');
  const sendBtn = document.getElementById('sendBtn');
  const resultEl = document.getElementById('result');
  const searchSection = document.getElementById('searchSection');

  let peer = null;
  let conn = null;
  let uptimeTimer = null;
  let pingTimer = null;
  let startTime = null;
  let myCode = null;
  let lastPong = Date.now();
  let role = /Mobi|Android/i.test(navigator.userAgent) ? 'phone' : 'computer';

  function getOrCreateCode() {
    if (myCode) return myCode;
    myCode = String(Math.floor(100000 + Math.random() * 900000));
    return myCode;
  }

  function resetUI() {
    phoneUI.hidden = true;
    computerUI.hidden = true;
    connectedUI.hidden = true;
    disconnectedUI.hidden = true;
  }

  function showPhoneUI() {
    role = 'phone';
    resetUI();
    phoneUI.hidden = false;
    phoneCodeEl.textContent = getOrCreateCode();
    setupPeer(myCode);
  }
  function showComputerUI() {
    role = 'computer';
    resetUI();
    computerUI.hidden = false;
    setupPeer(); // random id
  }
  function showConnectedUI() {
    resetUI();
    connectedUI.hidden = false;
  }
  function showDisconnectedUI() {
    resetUI();
    disconnectedUI.hidden = false;
  }

  switchToComputer.onclick = () => showComputerUI();
  switchToPhone.onclick = () => showPhoneUI();
  reconnectBtn.onclick = () => {
    if (role === 'phone') showPhoneUI();
    else showComputerUI();
  };

  connectBtn.onclick = () => {
    if (!peer) return;
    const target = codeInput.value.trim();
    if (!target) return alert("Enter a code.");
    if (target === myCode) return alert("Cannot connect to your own code!");
    conn = peer.connect(target, {reliable:true});
    conn.on('open', () => onConnected(conn));
    conn.on('data', onData);
    conn.on('close', onDisconnected);
  };

  function setupPeer(id) {
    if (peer) { try { peer.destroy(); } catch(e) {} peer = null; }
    peer = new Peer(id, {
      host: "peerjs.com",
      port: 443,
      path: "/",
      secure: true
    });
    peer.on('connection', dc => {
      conn = dc;
      conn.on('open', () => onConnected(conn));
      conn.on('data', onData);
      conn.on('close', onDisconnected);
    });
  }

  function onConnected(dc) {
    showConnectedUI();
    startTime = Date.now();
    if (uptimeTimer) clearInterval(uptimeTimer);
    uptimeTimer = setInterval(() => {
      const secs = Math.floor((Date.now()-startTime)/1000);
      uptimeEl.textContent = secs+"s";
      if (role === 'computer' && Date.now()-lastPong > 20000) {
        onDisconnected();
      }
    }, 1000);

    if (pingTimer) clearInterval(pingTimer);
    if (role === 'computer') {
      pingTimer = setInterval(() => {
        if (conn && conn.open) conn.send({type:'ping'});
      }, 10000);
    }

    if (role === 'computer') {
      searchSection.hidden = false;
    } else {
      searchSection.hidden = true;
      statusLine.textContent = "✅ Connected • Uptime " + uptimeEl.textContent;
    }
  }

  function onDisconnected() {
    if (uptimeTimer) clearInterval(uptimeTimer);
    if (pingTimer) clearInterval(pingTimer);
    uptimeTimer = pingTimer = null;
    showDisconnectedUI();
  }

  async function onData(data) {
    if (role === 'computer') {
      if (data.type === 'fetch-response') {
        resultEl.textContent = `Status: ${data.status}\n\n${data.bodyText}`;
      } else if (data.type === 'pong') {
        lastPong = Date.now();
        statusLine.innerHTML = `✅ Connected • Uptime <span id="uptime">${uptimeEl.textContent}</span>`;
      }
    } else if (role === 'phone') {
      if (data.type === 'fetch-request') {
        try {
          const proxied = "https://corsproxy.io/?" + encodeURIComponent(data.url);
          const r = await fetch(proxied, {method:"GET"});
          const text = await r.text();
          conn.send({type:'fetch-response', status:r.status, bodyText:text});
        } catch(e) {
          conn.send({type:'fetch-response', status:'error', bodyText:String(e)});
        }
      } else if (data.type === 'ping') {
        conn.send({type:'pong'});
      }
    }
  }

  sendBtn.onclick = () => {
    const url = urlInput.value.trim();
    if (!url) return;
    conn.send({type:'fetch-request', url});
    resultEl.textContent = "Fetching...";
  };
  urlInput.addEventListener("keypress", e => {
    if (e.key === "Enter") sendBtn.click();
  });

  if (role === 'phone') showPhoneUI(); else showComputerUI();
})();
</script>
</body>
</html>
