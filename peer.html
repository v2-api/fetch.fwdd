<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Phone Proxy</title>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<style>
  html,body{height:100%;margin:0;display:flex;justify-content:center;align-items:center;background:#fafafa;font-family:sans-serif}
  .card{background:#fff;border:1px solid #ccc;border-radius:12px;padding:1rem;width:100%;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,0.1);text-align:center}
  h1{font-size:1.2rem;margin:0 0 .6rem}
  input,button{width:100%;box-sizing:border-box;padding:.5rem;margin:.4rem 0;font-size:1rem;border-radius:8px;border:1px solid #ccc}
  button{background:#0b74de;color:#fff;border:0;cursor:pointer}
  button:disabled{background:#aaa;cursor:not-allowed}
  .link{color:#0b74de;cursor:pointer;font-size:.9rem;margin-top:.5rem;display:block}
  #result{margin-top:.6rem;text-align:left;white-space:pre-wrap;font-family:monospace;background:#f6f6f6;padding:.5rem;border-radius:8px;max-height:200px;overflow:auto}
</style>
</head>
<body>
<div class="card" id="phoneUI" hidden>
  <h1>Your Phone Code</h1>
  <div id="phoneCode" style="font-weight:700;font-size:1.6rem;letter-spacing:2px;margin:.5rem 0">------</div>
  <button id="resetCodeBtn">Reset Code</button>
  <div class="link" id="switchToComputer">I'm not on mobile</div>
  <div id="phoneStatus">Waiting…</div>
</div>

<div class="card" id="computerUI" hidden>
  <h1>Enter Phone Code</h1>
  <input id="codeInput" placeholder="6-digit code"/>
  <button id="connectBtn" disabled>Connect</button>
  <div class="link" id="switchToPhone">I'm not on computer</div>
  <div id="compStatus"></div>
</div>

<div class="card" id="connectedUI" hidden>
  <div id="statusLine">⏳ Connecting...</div>
  <div id="searchSection" hidden>
    <input id="urlInput" placeholder="Enter URL"/>
    <button id="sendBtn">Search</button>
    <div id="result"></div>
  </div>
  <div class="link" id="disconnectBtn">Disconnect</div>
</div>

<script>
(() => {
  let peer, conn, role, myCode;
  let startTime=0, uptimeTimer, pingTimer, lastPong=Date.now();

  // UI
  const phoneUI=document.getElementById('phoneUI');
  const computerUI=document.getElementById('computerUI');
  const connectedUI=document.getElementById('connectedUI');
  const phoneCodeEl=document.getElementById('phoneCode');
  const phoneStatus=document.getElementById('phoneStatus');
  const compStatus=document.getElementById('compStatus');
  const connectBtn=document.getElementById('connectBtn');
  const codeInput=document.getElementById('codeInput');
  const statusLine=document.getElementById('statusLine');
  const searchSection=document.getElementById('searchSection');
  const urlInput=document.getElementById('urlInput');
  const sendBtn=document.getElementById('sendBtn');
  const resultEl=document.getElementById('result');

  function setupRole(){
    role = /Mobi|Android/i.test(navigator.userAgent)?'phone':'computer';
    if(role==='phone'){
      myCode=localStorage.getItem('phoneCode')||String(Math.floor(100000+Math.random()*900000));
      localStorage.setItem('phoneCode',myCode);
      phoneCodeEl.textContent=myCode;
      peer=new Peer(myCode);
      phoneUI.hidden=false;
      peer.on('open',()=>phoneStatus.textContent='Ready, waiting for computer…');
      peer.on('connection',c=>{
        conn=c; wireConn();
        phoneUI.hidden=true; connectedUI.hidden=false; searchSection.hidden=true;
      });
    } else {
      peer=new Peer();
      computerUI.hidden=false;
      peer.on('open',()=>{ compStatus.textContent='Peer ready'; connectBtn.disabled=false; });
    }
  }

  function wireConn(){
    conn.on('open',()=>{
      startTime=Date.now();
      statusLine.textContent='✅ Connected • Uptime 0s';
      if(role==='computer') searchSection.hidden=false;
      uptimeTimer=setInterval(()=>{
        const s=Math.floor((Date.now()-startTime)/1000);
        statusLine.textContent='✅ Connected • Uptime '+s+'s';
        if(role==='computer' && Date.now()-lastPong>20000){
          statusLine.textContent='⚠️ Connection lost';
          conn.close();
        }
      },1000);
      if(role==='computer'){
        pingTimer=setInterval(()=>{ if(conn.open) conn.send({t:'ping'}); },8000);
      }
    });
    conn.on('data',async m=>{
      if(role==='computer'){
        if(m.t==='pong') lastPong=Date.now();
        if(m.t==='resp') resultEl.textContent=`Status: ${m.s}\n\n${m.b}`;
      } else {
        if(m.t==='ping') conn.send({t:'pong'});
        if(m.t==='req'){
          try{
            const r=await fetch('https://corsproxy.io/?'+encodeURIComponent(m.u));
            conn.send({t:'resp',s:r.status,b:await r.text()});
          }catch(e){ conn.send({t:'resp',s:'error',b:String(e)}); }
        }
      }
    });
    conn.on('close',()=>location.reload());
  }

  // events
  document.getElementById('resetCodeBtn').onclick=()=>{
    myCode=String(Math.floor(100000+Math.random()*900000));
    localStorage.setItem('phoneCode',myCode);
    phoneCodeEl.textContent=myCode;
    peer.destroy(); peer=new Peer(myCode);
    peer.on('connection',c=>{conn=c;wireConn();phoneUI.hidden=true;connectedUI.hidden=false;});
  };
  document.getElementById('switchToComputer').onclick=()=>{role='computer';location.reload();};
  document.getElementById('switchToPhone').onclick=()=>{role='phone';location.reload();};
  connectBtn.onclick=()=>{
    conn=peer.connect(codeInput.value.trim());
    computerUI.hidden=true; connectedUI.hidden=false;
    wireConn();
  };
  document.getElementById('sendBtn').onclick=()=>{
    if(!conn.open) return;
    resultEl.textContent='Fetching...';
    conn.send({t:'req',u:urlInput.value.trim()});
  };
  document.getElementById('disconnectBtn').onclick=()=>{conn.close();location.reload();};

  setupRole();
})();
</script>
</body>
</html>
