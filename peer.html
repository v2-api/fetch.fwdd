<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Phone Proxy</title>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<style>
  html, body {
    height:100%;
    margin:0;
    background:#121212;
    color:#eee;
    font-family: system-ui, sans-serif;
  }

  #app {
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .card {
    background:#1e1e1e;
    border:1px solid #333;
    border-radius:16px;
    padding:2rem;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    width:100%;
    max-width:380px;
    text-align:center;
  }

  h1 { font-size:1.4rem; margin-bottom:1rem; }

  input, button {
    font-size:1rem;
    padding:0.7rem 1rem;
    border-radius:10px;
    border:1px solid #555;
    margin:0.5rem 0;
    background:#2a2a2a;
    color:#eee;
    width:100%;
    box-sizing:border-box;
  }

  button {
    background:#0b74de;
    border:none;
    cursor:pointer;
    font-weight:bold;
  }
  button:disabled { opacity:0.6; cursor:not-allowed; }
  button:hover:enabled { background:#095ab0; }

  .link { 
    color:#4aa3ff; 
    font-size:0.9rem; 
    cursor:pointer; 
    margin-top:0.6rem; 
    display:inline-block; 
  }

  /* Connected computer UI */
  #connectedUI {
    display:flex;
    flex-direction:column;
    height:100%;
    width:100%;
  }
  #topbar {
    display:flex;
    gap:0.5rem;
    padding:0.6rem;
    background:#1e1e1e;
    border-bottom:1px solid #333;
  }
  #urlInput {
    flex:1;
    padding:0.6rem;
    font-size:1rem;
    border-radius:10px;
    border:1px solid #555;
    background:#2a2a2a;
    color:#eee;
  }
  #sendBtn {
    padding:0.6rem 1rem;
    flex:0;
    background:#0b74de;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:bold;
  }
  #sendBtn:hover:enabled { background:#095ab0; }

  #browser {
    flex:1;
    overflow:auto;
    background:#111;
    padding:1rem;
  }
  a { color:#4aa3ff; }

  /* Phone connected UI */
  #phoneConnected {
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    gap:1rem;
  }
  #uptime {
    font-size:1.1rem;
    color:#9acdff;
  }
</style>
</head>
<body>
<div id="app">
  <!-- Phone UI -->
  <div class="card" id="phoneUI">
    <h1>Your Code</h1>
    <div style="font-size:2rem; font-weight:bold; margin:1rem 0;" id="phoneCode">------</div>
    <button id="resetCodeBtn">Reset Code</button>
    <div class="link" id="switchToComputer">I'm not on mobile</div>
  </div>

  <!-- Phone Connected UI -->
  <div class="card" id="phoneConnected" hidden>
    <h1>ðŸ“± Connected</h1>
    <div id="uptime">Uptime: 0s</div>
    <button id="disconnectBtn">Disconnect</button>
  </div>

  <!-- Computer UI -->
  <div class="card" id="computerUI" hidden>
    <h1>Enter Phone Code</h1>
    <input id="codeInput" placeholder="6-digit code"/>
    <button id="connectBtn">Connect</button>
    <div class="link" id="switchToPhone">I'm not on computer</div>
  </div>
</div>

  <!-- Connected Computer UI (full screen) -->
  <div id="connectedUI" hidden>
    <div id="topbar">
      <input id="urlInput" placeholder="Enter URL to fetch"/>
      <button id="sendBtn">Go</button>
    </div>
    <div id="browser"></div>
  </div>

<script>
(() => {
  const phoneUI = document.getElementById('phoneUI');
  const phoneConnected = document.getElementById('phoneConnected');
  const computerUI = document.getElementById('computerUI');
  const connectedUI = document.getElementById('connectedUI');
  const app = document.getElementById('app');

  const phoneCodeEl = document.getElementById('phoneCode');
  const resetCodeBtn = document.getElementById('resetCodeBtn');
  const switchToComputer = document.getElementById('switchToComputer');
  const switchToPhone = document.getElementById('switchToPhone');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const codeInput = document.getElementById('codeInput');
  const connectBtn = document.getElementById('connectBtn');
  const urlInput = document.getElementById('urlInput');
  const sendBtn = document.getElementById('sendBtn');
  const browserEl = document.getElementById('browser');
  const uptimeEl = document.getElementById('uptime');

  let peer = null;
  let conn = null;
  let myCode = null;
  let role = /Mobi|Android/i.test(navigator.userAgent) ? 'phone' : 'computer';
  let uptimeStart = null;
  let uptimeTimer = null;

  function getOrCreateCode(reset=false) {
    if (!reset && myCode) return myCode;
    if (!reset) myCode = localStorage.getItem("phoneCode");
    if (!myCode || reset) {
      myCode = String(Math.floor(100000 + Math.random() * 900000));
      localStorage.setItem("phoneCode", myCode);
    }
    return myCode;
  }

  function resetUI() {
    phoneUI.hidden = true;
    phoneConnected.hidden = true;
    computerUI.hidden = true;
    connectedUI.hidden = true;
    app.hidden = false;
  }

  function showPhoneUI() {
    role = 'phone';
    resetUI();
    phoneUI.hidden = false;
    phoneCodeEl.textContent = getOrCreateCode();
    setupPeer(myCode);
  }

  function showPhoneConnected() {
    resetUI();
    phoneConnected.hidden = false;
    uptimeStart = Date.now();
    uptimeTimer = setInterval(updateUptime, 1000);
  }

  function updateUptime() {
    const seconds = Math.floor((Date.now() - uptimeStart) / 1000);
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    uptimeEl.textContent = `Uptime: ${mins}m ${secs}s`;
  }

  function showComputerUI() {
    role = 'computer';
    resetUI();
    computerUI.hidden = false;
    setupPeer();
  }

  function showConnectedUI() {
    resetUI();
    if (role === 'computer') {
      app.hidden = true;
      connectedUI.hidden = false;   // fullscreen browser
    } else if (role === 'phone') {
      phoneUI.hidden = true;
      showPhoneConnected();
    }
  }

  switchToComputer.onclick = () => showComputerUI();
  switchToPhone.onclick = () => showPhoneUI();
  resetCodeBtn.onclick = () => {
    getOrCreateCode(true);
    phoneCodeEl.textContent = myCode;
    setupPeer(myCode);
  };
  disconnectBtn.onclick = () => {
    if (conn) conn.close();
    if (peer) peer.destroy();
    clearInterval(uptimeTimer);
    showPhoneUI();
  };

  connectBtn.onclick = () => {
    if (!peer) return;
    const target = codeInput.value.trim();
    if (!target) return alert("Enter a code.");
    if (target === myCode) return alert("Cannot connect to your own code!");
    connectBtn.disabled = true;
    const dc = peer.connect(target, {reliable:true});
    dc.on('open', () => onConnected(dc));
    dc.on('data', onData);
    dc.on('close', onDisconnected);
    dc.on('error', err => { alert("Connection error: " + err); connectBtn.disabled = false; });
  };

  function setupPeer(id) {
    if (peer) { try { peer.destroy(); } catch(e) {} peer = null; }
    peer = new Peer(id);
    peer.on('connection', dc => {
      conn = dc;
      dc.on('open', () => onConnected(dc));
      dc.on('data', onData);
      dc.on('close', onDisconnected);
    });
    peer.on('error', err => { console.error("Peer error", err); });
  }

  function onConnected(dc) {
    conn = dc;
    showConnectedUI();
    connectBtn.disabled = false;
  }

  function onDisconnected() {
    resetUI();
    clearInterval(uptimeTimer);
    if (role === 'phone') {
      showPhoneUI();
    } else {
      showComputerUI();
    }
  }

  async function onData(data) {
    if (role === 'computer') {
      if (data.type === 'fetch-response') {
        renderPage(data.bodyText, urlInput.value);
      }
    } else if (role === 'phone') {
      if (data.type === 'fetch-request') {
        try {
          const proxied = "https://corsproxy.io/?" + encodeURIComponent(data.url);
          const r = await fetch(proxied);
          const text = await r.text();
          conn.send({type:'fetch-response', bodyText:text});
        } catch(e) {
          conn.send({type:'fetch-response', bodyText:"Error: "+String(e)});
        }
      }
    }
  }

  function renderPage(html, baseUrl) {
    const doc = new DOMParser().parseFromString(html, "text/html");
    const base = new URL(baseUrl);

    doc.querySelectorAll("[href]").forEach(el => {
      const val = el.getAttribute("href");
      if (val && !val.startsWith("http") && !val.startsWith("#")) {
        el.setAttribute("href", new URL(val, base).href);
      }
      el.addEventListener("click", e => {
        e.preventDefault();
        const href = el.getAttribute("href");
        if (href) {
          urlInput.value = href;
          sendBtn.click();
        }
      });
    });

    doc.querySelectorAll("[src]").forEach(el => {
      const val = el.getAttribute("src");
      if (val && !val.startsWith("http")) {
        el.setAttribute("src", new URL(val, base).href);
      }
    });

    browserEl.innerHTML = "";
    browserEl.appendChild(doc.body);
  }

  sendBtn.onclick = () => {
    const url = urlInput.value.trim();
    if (!url) return;
    conn.send({type:'fetch-request', url});
    browserEl.textContent = "Fetching...";
  };

  urlInput.addEventListener("keypress", e => { if (e.key === "Enter") sendBtn.click(); });

  // âœ… Correct initial UI
  if (role === 'phone') showPhoneUI();
  else showComputerUI();
})();
</script>
</body>
</html>
